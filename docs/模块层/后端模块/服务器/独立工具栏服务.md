# ç‹¬ç«‹å·¥å…·æ æœåŠ¡

## æœåŠ¡ä»‹ç»

ç‹¬ç«‹å·¥å…·æ æœåŠ¡æ˜¯ä»MCP Feedback Collectorä¸»é¡¹ç›®ä¸­å®Œå…¨è§£è€¦å‡ºæ¥çš„ç‹¬ç«‹æœåŠ¡ï¼Œä¸“é—¨ä¸ºè§£å†³å¤šæœåŠ¡ç¯å¢ƒä¸‹çš„Stagewiseå·¥å…·æ é›†æˆé—®é¢˜è€Œè®¾è®¡ã€‚é€šè¿‡åˆ›æ–°çš„åŒWebSocketæ¶æ„å’Œå›ºå®šç«¯å£ç­–ç•¥ï¼Œå®ç°äº†å®Œç¾çš„æœåŠ¡è§£è€¦å’Œå¤šå®ä¾‹æ”¯æŒã€‚

### æ ¸å¿ƒä»·å€¼

- **å½»åº•è§£è€¦**: ä»ä¸»é¡¹ç›®ä¸­å®Œå…¨ç‹¬ç«‹ï¼Œå¯å•ç‹¬éƒ¨ç½²ã€æ›´æ–°å’Œç»´æŠ¤
- **å¤šæœåŠ¡æ”¯æŒ**: æ”¯æŒå¤šä¸ªWebServiceå®ä¾‹åŒæ—¶æ¥æ”¶å·¥å…·æ prompt
- **å›ºå®šç«¯å£ç­–ç•¥**: ä½¿ç”¨5748ç«¯å£ï¼Œå½»åº•è§£å†³åŠ¨æ€ç«¯å£å¸¦æ¥çš„æœåŠ¡å‘ç°é—®é¢˜
- **å³æ’å³ç”¨**: å¯åŠ¨å³å¯ä½¿ç”¨ï¼Œæ— éœ€å¤æ‚é…ç½®

## æŠ€æœ¯ç‰¹æ€§

### ğŸš€ åˆ›æ–°æ¶æ„è®¾è®¡

#### åŒWebSocketæ¶æ„
```mermaid
graph TB
    subgraph "ç‹¬ç«‹å·¥å…·æ æœåŠ¡ (5748ç«¯å£)"
        A[ToolbarServer] --> B[SRPC WebSocket]
        A --> C[å¹¿æ’­WebSocket]
        A --> D[HTTP API]
        
        B --> E[å·¥å…·æ è¿æ¥]
        C --> F[WebServiceè¿æ¥]
        D --> G[çŠ¶æ€ç›‘æ§]
        
        E --> H[æ¥æ”¶prompt]
        F --> I[å¹¿æ’­prompt]
        G --> J[å¥åº·æ£€æŸ¥]
        
        H --> K[å¤„ç†SRPCè¯·æ±‚]
        I --> L[å®æ—¶åˆ†å‘]
        J --> M[æœåŠ¡çŠ¶æ€]
    end
    
    subgraph "å¤–éƒ¨æœåŠ¡"
        N[Stagewiseå·¥å…·æ ] --> |SRPC| B
        O[WebServiceå®ä¾‹1] --> |å¹¿æ’­| C
        P[WebServiceå®ä¾‹2] --> |å¹¿æ’­| C
        Q[WebServiceå®ä¾‹N] --> |å¹¿æ’­| C
    end
```

#### å›ºå®šç«¯å£ç­–ç•¥
- **ç«¯å£**: 5748 (å›ºå®šä¸å˜)
- **ä¼˜åŠ¿**: æ— éœ€åŠ¨æ€å‘ç°ï¼Œç®€åŒ–é›†æˆ
- **å…¼å®¹æ€§**: å®Œå…¨å…¼å®¹ç°æœ‰Stagewiseå·¥å…·æ 

### ğŸ”„ é€šä¿¡æœºåˆ¶

#### SRPC WebSocketé€šä¿¡
- **ç«¯ç‚¹**: `ws://localhost:5748`
- **åè®®**: Stagewiseæ ‡å‡†SRPCåè®®
- **åŠŸèƒ½**: æ¥æ”¶å·¥å…·æ çš„promptè¯·æ±‚

#### å¹¿æ’­WebSocketé€šä¿¡
- **ç«¯ç‚¹**: `ws://localhost:5748/broadcast`
- **åè®®**: è‡ªå®šä¹‰JSONæ¶ˆæ¯æ ¼å¼
- **åŠŸèƒ½**: å‘æ‰€æœ‰WebServiceå®ä¾‹å¹¿æ’­prompt

#### HTTP RESTful API
- **å¥åº·æ£€æŸ¥**: `GET /health`
- **æœåŠ¡çŠ¶æ€**: `GET /api/toolbar/status`
- **æœ€æ–°Prompt**: `GET /api/latest-prompt`
- **å®¢æˆ·ç«¯åˆ—è¡¨**: `GET /api/clients`
- **æœåŠ¡å‘ç°**: `GET /ping/stagewise`

### ğŸ›¡ï¸ å¯é æ€§ä¿è¯

#### è¿æ¥ç®¡ç†
- **è‡ªåŠ¨æ£€æµ‹**: å®æ—¶æ£€æµ‹è¿æ¥çŠ¶æ€
- **è‡ªåŠ¨æ¸…ç†**: æ¸…ç†æ–­å¼€çš„è¿æ¥
- **å¿ƒè·³æœºåˆ¶**: ä¿æŒè¿æ¥æ´»è·ƒ

#### é”™è¯¯å¤„ç†
- **ä¼˜é›…é™çº§**: éƒ¨åˆ†åŠŸèƒ½æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡
- **è¯¦ç»†æ—¥å¿—**: å®Œæ•´çš„é”™è¯¯è¿½è¸ªå’Œè°ƒè¯•ä¿¡æ¯
- **è‡ªåŠ¨æ¢å¤**: è¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿

## è§£è€¦è®¾è®¡

### é—®é¢˜èƒŒæ™¯

#### åŸæœ‰é›†æˆæ¶æ„çš„é—®é¢˜
```mermaid
graph TD
    A[Stagewiseå·¥å…·æ ] --> B[åŠ¨æ€ç«¯å£å‘ç°]
    B --> C[å¤šä¸ªMCPæœåŠ¡å®ä¾‹]
    C --> D[ç«¯å£å†²çª]
    C --> E[æœåŠ¡å‘ç°å¤æ‚]
    C --> F[å•ç‚¹æ•…éšœ]
    
    D --> G[å·¥å…·æ è¿æ¥å¤±è´¥]
    E --> H[é›†æˆå¤æ‚åº¦é«˜]
    F --> I[æœåŠ¡ä¸ç¨³å®š]
```

#### è§£è€¦åçš„æ¶æ„ä¼˜åŠ¿
```mermaid
graph TD
    A[Stagewiseå·¥å…·æ ] --> B[å›ºå®šç«¯å£5748]
    B --> C[ç‹¬ç«‹å·¥å…·æ æœåŠ¡]
    C --> D[WebSocketå¹¿æ’­]
    D --> E[å¤šä¸ªWebServiceå®ä¾‹]
    
    E --> F[å®ä¾‹1æ¥æ”¶prompt]
    E --> G[å®ä¾‹2æ¥æ”¶prompt]
    E --> H[å®ä¾‹Næ¥æ”¶prompt]
    
    F --> I[ç‹¬ç«‹å¤„ç†]
    G --> J[ç‹¬ç«‹å¤„ç†]
    H --> K[ç‹¬ç«‹å¤„ç†]
```

### è§£è€¦ä¼˜åŠ¿

#### 1. éƒ¨ç½²ç‹¬ç«‹æ€§
- **ç‹¬ç«‹éƒ¨ç½²**: å¯ä»¥å•ç‹¬éƒ¨ç½²å’Œæ›´æ–°
- **ç‰ˆæœ¬æ§åˆ¶**: ç‹¬ç«‹çš„ç‰ˆæœ¬ç®¡ç†
- **æ•…éšœéš”ç¦»**: æ•…éšœä¸å½±å“ä¸»é¡¹ç›®

#### 2. æ‰©å±•æ€§
- **æ°´å¹³æ‰©å±•**: æ”¯æŒå¤šä¸ªWebServiceå®ä¾‹
- **è´Ÿè½½å‡è¡¡**: è‡ªç„¶çš„è´Ÿè½½åˆ†æ•£
- **å¼¹æ€§ä¼¸ç¼©**: åŠ¨æ€å¢å‡å®ä¾‹

#### 3. ç»´æŠ¤æ€§
- **ç®€åŒ–ç»´æŠ¤**: ç‹¬ç«‹çš„ä»£ç åº“å’Œæ–‡æ¡£
- **ä¸“æ³¨åŠŸèƒ½**: ä¸“é—¨å¤„ç†å·¥å…·æ é›†æˆ
- **æµ‹è¯•ç‹¬ç«‹**: ç‹¬ç«‹çš„æµ‹è¯•å’ŒéªŒè¯

## å¤šæœåŠ¡æ”¯æŒ

### å·¥ä½œåŸç†

#### å¹¿æ’­æœºåˆ¶
```mermaid
sequenceDiagram
    participant T as Stagewiseå·¥å…·æ 
    participant S as ç‹¬ç«‹å·¥å…·æ æœåŠ¡
    participant W1 as WebServiceå®ä¾‹1
    participant W2 as WebServiceå®ä¾‹2
    participant W3 as WebServiceå®ä¾‹3
    
    Note over S: æœåŠ¡å¯åŠ¨ï¼Œç›‘å¬5748ç«¯å£
    
    W1->>S: è¿æ¥å¹¿æ’­WebSocket
    W2->>S: è¿æ¥å¹¿æ’­WebSocket
    W3->>S: è¿æ¥å¹¿æ’­WebSocket
    
    T->>S: å‘é€prompt (SRPC)
    S->>S: å¤„ç†promptè¯·æ±‚
    
    Note over S: åŒæ—¶å¹¿æ’­åˆ°æ‰€æœ‰è¿æ¥çš„WebService
    S->>W1: å¹¿æ’­prompt
    S->>W2: å¹¿æ’­prompt
    S->>W3: å¹¿æ’­prompt
    
    Note over W1,W3: æ‰€æœ‰å®ä¾‹åŒæ—¶å¤„ç†prompt
```

#### è¿æ¥ç®¡ç†
- **åŠ¨æ€è¿æ¥**: WebServiceå®ä¾‹å¯ä»¥éšæ—¶è¿æ¥å’Œæ–­å¼€
- **çŠ¶æ€è·Ÿè¸ª**: å®æ—¶è·Ÿè¸ªæ¯ä¸ªè¿æ¥çš„çŠ¶æ€
- **è‡ªåŠ¨æ¸…ç†**: è‡ªåŠ¨æ¸…ç†æ–­å¼€çš„è¿æ¥

### ä½¿ç”¨åœºæ™¯

#### 1. å¼€å‘ç¯å¢ƒ
- **å¤šä¸ªå¼€å‘è€…**: æ¯ä¸ªå¼€å‘è€…è¿è¡Œè‡ªå·±çš„WebServiceå®ä¾‹
- **åŒæ—¶è°ƒè¯•**: æ‰€æœ‰å®ä¾‹åŒæ—¶æ”¶åˆ°å·¥å…·æ prompt
- **ç‹¬ç«‹å¼€å‘**: ä¸å½±å“å…¶ä»–å¼€å‘è€…çš„å·¥ä½œ

#### 2. æµ‹è¯•ç¯å¢ƒ
- **A/Bæµ‹è¯•**: ä¸åŒç‰ˆæœ¬çš„æœåŠ¡åŒæ—¶è¿è¡Œ
- **å‹åŠ›æµ‹è¯•**: å¤šå®ä¾‹å¹¶å‘å¤„ç†
- **åŠŸèƒ½éªŒè¯**: ç‹¬ç«‹éªŒè¯å„ä¸ªåŠŸèƒ½æ¨¡å—

#### 3. ç”Ÿäº§ç¯å¢ƒ
- **é«˜å¯ç”¨**: å¤šå®ä¾‹éƒ¨ç½²ï¼Œæé«˜å¯ç”¨æ€§
- **è´Ÿè½½åˆ†æ•£**: è‡ªç„¶çš„è´Ÿè½½åˆ†æ•£æœºåˆ¶
- **æ•…éšœæ¢å¤**: å•ä¸ªå®ä¾‹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡

## éƒ¨ç½²é…ç½®

### ç¯å¢ƒè¦æ±‚

#### ç³»ç»Ÿè¦æ±‚
- **Node.js**: ç‰ˆæœ¬ >= 18.0.0
- **æ“ä½œç³»ç»Ÿ**: Windows, macOS, Linux
- **å†…å­˜**: æœ€å°‘ 128MB
- **å­˜å‚¨**: æœ€å°‘ 50MB

#### ç½‘ç»œè¦æ±‚
- **ç«¯å£**: 5748 (éœ€è¦å¯è®¿é—®)
- **é˜²ç«å¢™**: å…è®¸5748ç«¯å£çš„å…¥ç«™è¿æ¥
- **ç½‘ç»œ**: æ”¯æŒWebSocketè¿æ¥

### éƒ¨ç½²æ­¥éª¤

#### 1. è·å–ä»£ç 
```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd mcp-feedback-collector/toolbar
```

#### 2. å®‰è£…ä¾èµ–
```bash
# å®‰è£…ä¾èµ–åŒ…
npm install

# éªŒè¯å®‰è£…
npm list
```

#### 3. æ„å»ºé¡¹ç›®
```bash
# æ„å»ºTypeScriptä»£ç 
npm run build

# éªŒè¯æ„å»º
ls -la dist/
```

#### 4. å¯åŠ¨æœåŠ¡
```bash
# å¼€å‘æ¨¡å¼ (è‡ªåŠ¨é‡å¯)
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm run start

# åå°è¿è¡Œ (Linux/macOS)
nohup npm run start > toolbar.log 2>&1 &
```

#### 5. éªŒè¯éƒ¨ç½²
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:5748/health

# æœåŠ¡çŠ¶æ€
curl http://localhost:5748/api/toolbar/status

# Pingæµ‹è¯•
curl http://localhost:5748/ping/stagewise
```

### é…ç½®é€‰é¡¹

#### ç¯å¢ƒå˜é‡
```bash
# æ—¥å¿—çº§åˆ«
export LOG_LEVEL=debug

# ç«¯å£é…ç½® (å¯é€‰ï¼Œé»˜è®¤5748)
export TOOLBAR_PORT=5748

# æœåŠ¡åç§°
export SERVICE_NAME=standalone-toolbar-service
```

#### é…ç½®æ–‡ä»¶ (å¯é€‰)
```json
{
  "port": 5748,
  "logging": {
    "level": "info",
    "format": "combined"
  },
  "websocket": {
    "heartbeat": 30000,
    "timeout": 60000
  }
}
```

## ä½¿ç”¨ç¤ºä¾‹

### WebServiceé›†æˆ

#### åŸºç¡€é›†æˆ
```javascript
// è¿æ¥åˆ°ç‹¬ç«‹å·¥å…·æ æœåŠ¡
const WebSocket = require('ws');

class ToolbarIntegration {
  constructor() {
    this.ws = null;
    this.connected = false;
  }

  connect() {
    this.ws = new WebSocket('ws://localhost:5748/broadcast');
    
    this.ws.on('open', () => {
      console.log('Connected to standalone toolbar service');
      this.connected = true;
    });

    this.ws.on('message', (data) => {
      const message = JSON.parse(data);
      this.handleMessage(message);
    });

    this.ws.on('close', () => {
      console.log('Disconnected from toolbar service');
      this.connected = false;
      // è‡ªåŠ¨é‡è¿
      setTimeout(() => this.connect(), 5000);
    });
  }

  handleMessage(message) {
    switch (message.event) {
      case 'welcome':
        console.log('Welcome from toolbar service:', message.data);
        break;
      case 'prompt_received':
        this.handlePrompt(message.data);
        break;
      case 'pong':
        console.log('Heartbeat response received');
        break;
    }
  }

  handlePrompt(promptData) {
    console.log('Received prompt from toolbar:', promptData.prompt);
    
    // åœ¨ä½ çš„WebServiceä¸­å¤„ç†prompt
    this.processPrompt(promptData);
  }

  processPrompt(promptData) {
    // å®ç°ä½ çš„promptå¤„ç†é€»è¾‘
    console.log('Processing prompt:', {
      prompt: promptData.prompt,
      sessionId: promptData.sessionId,
      timestamp: promptData.timestamp
    });
  }

  // å‘é€å¿ƒè·³
  sendHeartbeat() {
    if (this.connected && this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(JSON.stringify({ type: 'ping' }));
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const toolbar = new ToolbarIntegration();
toolbar.connect();

// å®šæœŸå‘é€å¿ƒè·³
setInterval(() => {
  toolbar.sendHeartbeat();
}, 30000);
```

#### é«˜çº§é›†æˆ
```javascript
// å¸¦æœ‰é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶çš„é›†æˆ
class AdvancedToolbarIntegration {
  constructor(options = {}) {
    this.options = {
      url: 'ws://localhost:5748/broadcast',
      reconnectInterval: 5000,
      heartbeatInterval: 30000,
      maxReconnectAttempts: 10,
      ...options
    };
    
    this.ws = null;
    this.connected = false;
    this.reconnectAttempts = 0;
    this.heartbeatTimer = null;
  }

  async connect() {
    try {
      this.ws = new WebSocket(this.options.url);
      
      this.ws.on('open', () => {
        console.log('Connected to standalone toolbar service');
        this.connected = true;
        this.reconnectAttempts = 0;
        this.startHeartbeat();
      });

      this.ws.on('message', (data) => {
        try {
          const message = JSON.parse(data);
          this.handleMessage(message);
        } catch (error) {
          console.error('Failed to parse message:', error);
        }
      });

      this.ws.on('close', () => {
        console.log('Disconnected from toolbar service');
        this.connected = false;
        this.stopHeartbeat();
        this.attemptReconnect();
      });

      this.ws.on('error', (error) => {
        console.error('WebSocket error:', error);
      });

    } catch (error) {
      console.error('Failed to connect:', error);
      this.attemptReconnect();
    }
  }

  attemptReconnect() {
    if (this.reconnectAttempts < this.options.maxReconnectAttempts) {
      this.reconnectAttempts++;
      console.log(`Attempting reconnect ${this.reconnectAttempts}/${this.options.maxReconnectAttempts}`);
      
      setTimeout(() => {
        this.connect();
      }, this.options.reconnectInterval);
    } else {
      console.error('Max reconnect attempts reached');
    }
  }

  startHeartbeat() {
    this.heartbeatTimer = setInterval(() => {
      if (this.connected && this.ws.readyState === WebSocket.OPEN) {
        this.ws.send(JSON.stringify({ type: 'ping' }));
      }
    }, this.options.heartbeatInterval);
  }

  stopHeartbeat() {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer);
      this.heartbeatTimer = null;
    }
  }

  handleMessage(message) {
    switch (message.event) {
      case 'welcome':
        console.log('Welcome from toolbar service:', message.data);
        this.onWelcome(message.data);
        break;
      case 'prompt_received':
        this.onPromptReceived(message.data);
        break;
      case 'pong':
        this.onHeartbeatResponse();
        break;
      default:
        console.log('Unknown message type:', message.event);
    }
  }

  onWelcome(data) {
    // å¤„ç†æ¬¢è¿æ¶ˆæ¯
    console.log('Client ID:', data.clientId);
  }

  onPromptReceived(promptData) {
    // å¤„ç†æ¥æ”¶åˆ°çš„prompt
    console.log('Received prompt:', promptData.prompt);
    
    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
    this.emit('prompt', promptData);
  }

  onHeartbeatResponse() {
    // å¤„ç†å¿ƒè·³å“åº”
    console.log('Heartbeat OK');
  }

  // ç®€å•çš„äº‹ä»¶å‘å°„å™¨
  emit(event, data) {
    if (this.listeners && this.listeners[event]) {
      this.listeners[event].forEach(callback => {
        try {
          callback(data);
        } catch (error) {
          console.error('Event listener error:', error);
        }
      });
    }
  }

  on(event, callback) {
    if (!this.listeners) {
      this.listeners = {};
    }
    if (!this.listeners[event]) {
      this.listeners[event] = [];
    }
    this.listeners[event].push(callback);
  }

  disconnect() {
    this.stopHeartbeat();
    if (this.ws) {
      this.ws.close();
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const toolbar = new AdvancedToolbarIntegration();

// ç›‘å¬promptäº‹ä»¶
toolbar.on('prompt', (promptData) => {
  console.log('Processing prompt:', promptData.prompt);
  // åœ¨è¿™é‡Œå®ç°ä½ çš„promptå¤„ç†é€»è¾‘
});

// è¿æ¥åˆ°æœåŠ¡
toolbar.connect();

// ä¼˜é›…å…³é—­
process.on('SIGINT', () => {
  console.log('Shutting down...');
  toolbar.disconnect();
  process.exit(0);
});
```

### çŠ¶æ€ç›‘æ§

#### æœåŠ¡çŠ¶æ€æ£€æŸ¥
```javascript
// æ£€æŸ¥æœåŠ¡çŠ¶æ€çš„å·¥å…·å‡½æ•°
async function checkToolbarServiceStatus() {
  try {
    const response = await fetch('http://localhost:5748/api/toolbar/status');
    const status = await response.json();
    
    console.log('Toolbar Service Status:', {
      running: status.running,
      srpcConnected: status.srpcConnected,
      broadcastClients: status.broadcastClients,
      uptime: status.uptime,
      version: status.version
    });
    
    return status;
  } catch (error) {
    console.error('Failed to check toolbar service status:', error);
    return null;
  }
}

// å®šæœŸæ£€æŸ¥æœåŠ¡çŠ¶æ€
setInterval(async () => {
  const status = await checkToolbarServiceStatus();
  if (!status || !status.running) {
    console.warn('Toolbar service may be down');
  }
}, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

#### å®¢æˆ·ç«¯è¿æ¥ç›‘æ§
```javascript
// ç›‘æ§è¿æ¥çš„å®¢æˆ·ç«¯
async function monitorClients() {
  try {
    const response = await fetch('http://localhost:5748/api/clients');
    const data = await response.json();
    
    console.log('Connected Clients:', {
      count: data.clientCount,
      clients: data.clients.map(client => ({
        id: client.id,
        connected: client.connected,
        lastActivity: new Date(client.lastActivity)
      }))
    });
    
    return data;
  } catch (error) {
    console.error('Failed to get client list:', error);
    return null;
  }
}

// å®šæœŸç›‘æ§å®¢æˆ·ç«¯è¿æ¥
setInterval(monitorClients, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è§£å†³

#### 1. æœåŠ¡å¯åŠ¨å¤±è´¥

**é—®é¢˜**: æœåŠ¡æ— æ³•å¯åŠ¨ï¼Œæç¤ºç«¯å£å ç”¨
```bash
Error: listen EADDRINUSE: address already in use :::5748
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
netstat -tulpn | grep 5748
# æˆ–è€…
lsof -i :5748

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 <PID>

# é‡æ–°å¯åŠ¨æœåŠ¡
npm run start
```

#### 2. WebSocketè¿æ¥å¤±è´¥

**é—®é¢˜**: WebServiceæ— æ³•è¿æ¥åˆ°å¹¿æ’­WebSocket
```
WebSocket connection failed: Error: connect ECONNREFUSED 127.0.0.1:5748
```

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:5748/health

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
sudo ufw status
sudo ufw allow 5748

# æ£€æŸ¥æœåŠ¡æ—¥å¿—
npm run start 2>&1 | tee toolbar.log
```

#### 3. å¹¿æ’­æ¶ˆæ¯æœªæ”¶åˆ°

**é—®é¢˜**: WebServiceè¿æ¥æˆåŠŸä½†æ”¶ä¸åˆ°promptå¹¿æ’­

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€
curl http://localhost:5748/api/clients

# æ£€æŸ¥æœ€æ–°promptçŠ¶æ€
curl http://localhost:5748/api/latest-prompt

# æ£€æŸ¥WebServiceè¿æ¥ç«¯ç‚¹
# ç¡®ä¿è¿æ¥åˆ° ws://localhost:5748/broadcast è€Œä¸æ˜¯ ws://localhost:5748
```

#### 4. SRPCé€šä¿¡å¼‚å¸¸

**é—®é¢˜**: Stagewiseå·¥å…·æ æ— æ³•ä¸æœåŠ¡é€šä¿¡

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ£€æŸ¥pingç«¯ç‚¹
curl http://localhost:5748/ping/stagewise

# æ£€æŸ¥SRPCçŠ¶æ€
curl http://localhost:5748/api/toolbar/status

# æ£€æŸ¥å·¥å…·æ é…ç½®
# ç¡®ä¿å·¥å…·æ é…ç½®æŒ‡å‘æ­£ç¡®çš„ç«¯å£5748
```

### è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—
```bash
# è®¾ç½®è¯¦ç»†æ—¥å¿—çº§åˆ«
export LOG_LEVEL=debug
npm run start

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f toolbar.log
```

#### ä½¿ç”¨è°ƒè¯•å·¥å…·
```javascript
// åœ¨ä»£ç ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
console.log('WebSocket connection state:', ws.readyState);
console.log('Message received:', JSON.stringify(message, null, 2));
```

#### ç½‘ç»œè°ƒè¯•
```bash
# ä½¿ç”¨netcatæµ‹è¯•ç«¯å£è¿é€šæ€§
nc -zv localhost 5748

# ä½¿ç”¨curlæµ‹è¯•HTTPç«¯ç‚¹
curl -v http://localhost:5748/health

# ä½¿ç”¨wscatæµ‹è¯•WebSocketè¿æ¥
npm install -g wscat
wscat -c ws://localhost:5748/broadcast
```

## æ€§èƒ½ä¼˜åŒ–

### è¿æ¥ä¼˜åŒ–

#### è¿æ¥æ± ç®¡ç†
```javascript
class ConnectionPool {
  constructor(maxConnections = 10) {
    this.maxConnections = maxConnections;
    this.connections = new Map();
  }

  getConnection(id) {
    if (!this.connections.has(id)) {
      if (this.connections.size >= this.maxConnections) {
        // ç§»é™¤æœ€æ—§çš„è¿æ¥
        const oldestId = this.connections.keys().next().value;
        this.removeConnection(oldestId);
      }
      
      const connection = new AdvancedToolbarIntegration();
      this.connections.set(id, connection);
      connection.connect();
    }
    
    return this.connections.get(id);
  }

  removeConnection(id) {
    const connection = this.connections.get(id);
    if (connection) {
      connection.disconnect();
      this.connections.delete(id);
    }
  }
}
```

#### æ¶ˆæ¯æ‰¹å¤„ç†
```javascript
class BatchProcessor {
  constructor(batchSize = 10, flushInterval = 1000) {
    this.batchSize = batchSize;
    this.flushInterval = flushInterval;
    this.batch = [];
    this.timer = null;
  }

  addMessage(message) {
    this.batch.push(message);
    
    if (this.batch.length >= this.batchSize) {
      this.flush();
    } else if (!this.timer) {
      this.timer = setTimeout(() => this.flush(), this.flushInterval);
    }
  }

  flush() {
    if (this.batch.length > 0) {
      this.processBatch(this.batch);
      this.batch = [];
    }
    
    if (this.timer) {
      clearTimeout(this.timer);
      this.timer = null;
    }
  }

  processBatch(messages) {
    console.log(`Processing batch of ${messages.length} messages`);
    messages.forEach(message => {
      // å¤„ç†æ¶ˆæ¯
    });
  }
}
```

### å†…å­˜ä¼˜åŒ–

#### å†…å­˜ç›‘æ§
```javascript
// å®šæœŸç›‘æ§å†…å­˜ä½¿ç”¨
function monitorMemory() {
  const usage = process.memoryUsage();
  console.log('Memory Usage:', {
    rss: `${Math.round(usage.rss / 1024 / 1024)} MB`,
    heapTotal: `${Math.round(usage.heapTotal / 1024 / 1024)} MB`,
    heapUsed: `${Math.round(usage.heapUsed / 1024 / 1024)} MB`,
    external: `${Math.round(usage.external / 1024 / 1024)} MB`
  });
}

setInterval(monitorMemory, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

#### åƒåœ¾å›æ”¶ä¼˜åŒ–
```javascript
// æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ (ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨)
if (global.gc) {
  setInterval(() => {
    global.gc();
  }, 300000); // æ¯5åˆ†é’Ÿ
}
```

## å®‰å…¨è€ƒè™‘

### ç½‘ç»œå®‰å…¨

#### CORSé…ç½®
```javascript
// ç”Ÿäº§ç¯å¢ƒCORSé…ç½®
const corsOptions = {
  origin: process.env.NODE_ENV === 'production' 
    ? ['https://yourdomain.com'] 
    : '*',
  methods: ['GET', 'POST'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true
};
```

#### è¾“å…¥éªŒè¯
```javascript
// éªŒè¯WebSocketæ¶ˆæ¯
function validateMessage(message) {
  if (!message || typeof message !== 'object') {
    throw new Error('Invalid message format');
  }
  
  if (message.type === 'ping' && Object.keys(message).length !== 1) {
    throw new Error('Invalid ping message');
  }
  
  // æ›´å¤šéªŒè¯é€»è¾‘...
}
```

### è®¿é—®æ§åˆ¶

#### ç®€å•çš„Tokenè®¤è¯
```javascript
// åœ¨WebSocketè¿æ¥æ—¶éªŒè¯token
function authenticateConnection(request) {
  const token = request.headers.authorization;
  
  if (!token || !isValidToken(token)) {
    throw new Error('Authentication failed');
  }
  
  return true;
}

function isValidToken(token) {
  // å®ç°tokenéªŒè¯é€»è¾‘
  return token === process.env.TOOLBAR_TOKEN;
}
```

## ğŸ§­ å¯¼èˆªé“¾æ¥

- **ğŸ“‹ [è¿”å›æœåŠ¡å™¨æ¨¡å—å¯¼èˆª](./index.md)** - è¿”å›æœåŠ¡å™¨æ¨¡å—ä¸»ç›®å½•
- **ğŸ”§ [ç‹¬ç«‹ToolbaræœåŠ¡å™¨æ–‡æ¡£](./toolbar-server.md)** - æŸ¥çœ‹æŠ€æœ¯å®ç°è¯¦æƒ…
- **ğŸ”§ [RPCå¤„ç†å™¨æ–‡æ¡£](./rpc-handler.md)** - æŸ¥çœ‹RPCå¤„ç†å™¨æ–‡æ¡£
- **ğŸ”§ [è¿”å›åç«¯æ¨¡å—å¯¼èˆª](../index.md)** - è¿”å›åç«¯æ¨¡å—å¯¼èˆª
- **ğŸ”§ [è¿”å›æ¨¡å—å±‚ç›®å½•](../../index.md)** - è¿”å›æ¨¡å—å±‚å¯¼èˆª
- **ğŸ“‹ [è¿”å›ä¸»ç›®å½•](../../../README.md)** - è¿”å›æ–‡æ¡£å¯¼èˆªä¸­å¿ƒ

---

*ç‹¬ç«‹å·¥å…·æ æœåŠ¡æ–‡æ¡£æœ€åæ›´æ–°: 2024å¹´12æœˆ* 