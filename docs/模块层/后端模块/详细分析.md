# åç«¯æ¨¡å—å†…éƒ¨ç»“æ„ä¸å…³é”®æ–‡ä»¶åˆ†æ

## æ¨¡å—æ¦‚è¿°

### åŠŸèƒ½èŒè´£
åç«¯æ¨¡å—æ˜¯MCP Feedback Collectorçš„æ ¸å¿ƒæœåŠ¡å±‚ï¼ŒåŸºäºNode.jså’ŒTypeScriptæ„å»ºï¼Œè´Ÿè´£ï¼š
- **MCPåè®®å®ç°**: å®Œæ•´çš„Model Context Protocolåè®®æ”¯æŒå’Œå·¥å…·æ³¨å†Œ
- **åœºæ™¯åŒ–æ•°æ®ç®¡ç†**: SQLiteæ•°æ®åº“å­˜å‚¨åœºæ™¯ã€æ¨¡å¼å’Œæç¤ºè¯é…ç½®
- **WebæœåŠ¡**: ExpressæœåŠ¡å™¨æä¾›HTTP APIå’Œé™æ€æ–‡ä»¶æœåŠ¡
- **å®æ—¶é€šä¿¡**: Socket.IOæœåŠ¡å™¨å®ç°ä¸å‰ç«¯çš„å®æ—¶åŒå‘é€šä¿¡
- **ä¼šè¯ç®¡ç†**: å¤šå®¢æˆ·ç«¯ä¼šè¯éš”ç¦»å’ŒçŠ¶æ€ç®¡ç†
- **å›¾ç‰‡å¤„ç†**: å›¾ç‰‡ä¸Šä¼ ã€å‹ç¼©å’Œå­˜å‚¨æœåŠ¡
- **æ€§èƒ½ç›‘æ§**: å®æ—¶æ€§èƒ½æŒ‡æ ‡æ”¶é›†å’Œç›‘æ§
- **Stagewiseé›†æˆ**: å·¥å…·æ æœåŠ¡å™¨å’ŒRPCæ¡¥æ¥æœåŠ¡

### æŠ€æœ¯æ¶æ„
- **è¿è¡Œæ—¶**: Node.js 18.0.0+
- **ç±»å‹ç³»ç»Ÿ**: TypeScript 5.2.2
- **Webæ¡†æ¶**: Express 4.18.2
- **å®æ—¶é€šä¿¡**: Socket.IO 4.7.2
- **æ•°æ®åº“**: Better-SQLite3 9.2.2
- **MCPåè®®**: @modelcontextprotocol/sdk 1.12.3
- **è¿›ç¨‹ç®¡ç†**: å¤šæœåŠ¡å™¨åè°ƒå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

### ä¾èµ–å…³ç³»
- **å¯¹å¤–æ¥å£**: æä¾›MCPåè®®æ¥å£ã€HTTP APIã€Socket.IOå®æ—¶é€šä¿¡
- **å†…éƒ¨ä¾èµ–**: æœåŠ¡å™¨é—´åè°ƒã€æ•°æ®åº“å­˜å‚¨ã€ä¼šè¯ç®¡ç†ã€æ€§èƒ½ç›‘æ§

## ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ cli.ts                      # CLIå‘½ä»¤è¡Œå…¥å£ (13KB, 435è¡Œ)
â”œâ”€â”€ index.ts                    # ä¸»æ¨¡å—å¯¼å‡º (501B, 17è¡Œ)
â”œâ”€â”€ server/                     # æœåŠ¡å™¨æ¨¡å—ç»„
â”‚   â”œâ”€â”€ mcp-server.ts           # MCPåè®®æœåŠ¡å™¨ (19KB, 646è¡Œ)
â”‚   â”œâ”€â”€ web-server.ts           # WebæœåŠ¡å™¨å’ŒSocket.IO (66KB, 1990è¡Œ)
â”‚   â”œâ”€â”€ toolbar-server.ts       # Stagewiseå·¥å…·æ æœåŠ¡å™¨ (11KB, 384è¡Œ)
â”‚   â”œâ”€â”€ server-coordinator.ts   # æœåŠ¡å™¨åè°ƒå™¨ (8.4KB, 318è¡Œ)
â”‚   â”œâ”€â”€ stdio-server-launcher.ts # Stdioæ¨¡å¼å¯åŠ¨å™¨ (7.9KB, 283è¡Œ)
â”‚   â””â”€â”€ web-server-manager.ts   # WebæœåŠ¡å™¨ç®¡ç†å™¨ (5.7KB, 221è¡Œ)
â”œâ”€â”€ utils/                      # å·¥å…·æ¨¡å—ç»„
â”‚   â”œâ”€â”€ prompt-database.ts      # SQLiteæ•°æ®åº“ç®¡ç† (30KB, 931è¡Œ)
â”‚   â”œâ”€â”€ prompt-manager.ts       # æç¤ºè¯ç®¡ç†å™¨ (20KB, 676è¡Œ)
â”‚   â”œâ”€â”€ session-storage.ts      # ä¼šè¯å­˜å‚¨ç®¡ç† (8.3KB, 343è¡Œ)
â”‚   â”œâ”€â”€ image-processor.ts      # å›¾ç‰‡å¤„ç†å™¨ (5.8KB, 218è¡Œ)
â”‚   â”œâ”€â”€ performance-monitor.ts  # æ€§èƒ½ç›‘æ§å™¨ (8.0KB, 321è¡Œ)
â”‚   â”œâ”€â”€ logger.ts               # æ—¥å¿—ç³»ç»Ÿ (5.8KB, 236è¡Œ)
â”‚   â”œâ”€â”€ port-manager.ts         # ç«¯å£ç®¡ç†å™¨ (11KB, 416è¡Œ)
â”‚   â”œâ”€â”€ client-identifier.ts    # å®¢æˆ·ç«¯è¯†åˆ«å™¨ (3.1KB, 144è¡Œ)
â”‚   â”œâ”€â”€ session-context.ts      # ä¼šè¯ä¸Šä¸‹æ–‡ç®¡ç† (1.8KB, 64è¡Œ)
â”‚   â”œâ”€â”€ process-manager.ts      # è¿›ç¨‹ç®¡ç†å™¨ (7.8KB, 289è¡Œ)
â”‚   â””â”€â”€ mode-detector.ts        # æ¨¡å¼æ£€æµ‹å™¨ (3.6KB, 130è¡Œ)
â”œâ”€â”€ config/                     # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ index.ts                # é…ç½®æ–‡ä»¶å’Œç¯å¢ƒå˜é‡å¤„ç†
â”œâ”€â”€ toolbar/                    # Stagewiseå·¥å…·æ é›†æˆ
â”‚   â”œâ”€â”€ index.ts                # å·¥å…·æ ä¸»å…¥å£
â”‚   â”œâ”€â”€ bridge/                 # æ¡¥æ¥æœåŠ¡
â”‚   â”‚   â””â”€â”€ srpc-websocket-bridge.ts # RPC WebSocketæ¡¥æ¥
â”‚   â”œâ”€â”€ handlers/               # å¤„ç†å™¨
â”‚   â”‚   â”œâ”€â”€ ai-agent.ts         # AIä»£ç†å¤„ç†å™¨
â”‚   â”‚   â””â”€â”€ rpc-handler.ts      # RPCå¤„ç†å™¨
â”‚   â””â”€â”€ types/                  # å·¥å…·æ ç±»å‹å®šä¹‰
â””â”€â”€ types/                      # å…¨å±€ç±»å‹å®šä¹‰
    â””â”€â”€ index.ts                # ä¸»è¦ç±»å‹å®šä¹‰
```

## æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. æœåŠ¡å™¨åè°ƒæ¶æ„

```mermaid
graph TB
    subgraph "æœåŠ¡å™¨åè°ƒå±‚"
        A[Server Coordinator] --> B[MCP Server]
        A --> C[Web Server]
        A --> D[Toolbar Server]
        A --> E[Port Manager]
    end
    
    subgraph "MCPåè®®å±‚"
        B --> F[Stdio Transport]
        B --> G[HTTP Transport]
        B --> H[Tool Registration]
        H --> I[collect_feedback Tool]
    end
    
    subgraph "WebæœåŠ¡å±‚"
        C --> J[Express Server]
        C --> K[Socket.IO Server]
        C --> L[Static Files]
        J --> M[API Routes]
        K --> N[Real-time Events]
    end
    
    subgraph "å·¥å…·æ é›†æˆå±‚"
        D --> O[RPC Bridge]
        D --> P[WebSocket Handler]
        D --> Q[AI Agent]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        E --> R[Port Allocation]
        S[Session Storage] --> T[SQLite Database]
        U[Performance Monitor] --> V[Metrics Collection]
        W[Logger] --> X[Log Management]
    end
    
    B --> S
    C --> S
    C --> U
    A --> W
```

### 2. æ•°æ®åº“å­˜å‚¨æ¶æ„

```mermaid
graph TB
    subgraph "æ•°æ®åº“å±‚"
        A[Better-SQLite3] --> B[Prompt Database]
        B --> C[Scene Management]
        B --> D[Mode Management]
        B --> E[Prompt Storage]
        B --> F[Session Storage]
    end
    
    subgraph "æ•°æ®æ¨¡å‹"
        G[Scene Entity] --> H[SceneMode Entity]
        H --> I[ScenePrompt Entity]
        J[Session Entity] --> K[Feedback Entity]
    end
    
    subgraph "æ•°æ®æ“ä½œ"
        L[CRUD Operations] --> M[Scene CRUD]
        L --> N[Mode CRUD]
        L --> O[Prompt CRUD]
        L --> P[Session CRUD]
    end
    
    subgraph "æ•°æ®è¿ç§»"
        Q[Version Control] --> R[Database Migration]
        R --> S[Schema Updates]
        R --> T[Data Migration]
    end
    
    C --> G
    D --> H
    E --> I
    F --> J
    M --> C
    N --> D
    O --> E
    P --> F
    B --> Q
```

### 3. ä¸šåŠ¡æµç¨‹æ¶æ„

```mermaid
graph LR
    subgraph "å®¢æˆ·ç«¯è¯·æ±‚"
        A[MCP Client] --> B[collect_feedback]
        C[Web Client] --> D[Socket.IO Event]
        E[Toolbar Client] --> F[RPC Call]
    end
    
    subgraph "æœåŠ¡å™¨å¤„ç†"
        B --> G[MCP Server]
        D --> H[Web Server]
        F --> I[Toolbar Server]
    end
    
    subgraph "ä¸šåŠ¡é€»è¾‘"
        G --> J[Session Management]
        H --> K[Feedback Processing]
        I --> L[Prompt Processing]
    end
    
    subgraph "æ•°æ®å­˜å‚¨"
        J --> M[SQLite Database]
        K --> N[File System]
        L --> M
    end
    
    subgraph "å“åº”è¿”å›"
        M --> O[Database Response]
        N --> P[File Response]
        O --> Q[Client Response]
        P --> Q
    end
```

## å…³é”®æ–‡ä»¶åˆ†æ

### æ ¸å¿ƒæœåŠ¡å™¨æ–‡ä»¶

#### mcp-server.ts (MCPåè®®æœåŠ¡å™¨)
- **è·¯å¾„**: `src/server/mcp-server.ts`
- **ä¸»è¦åŠŸèƒ½**: MCPåè®®çš„æ ¸å¿ƒå®ç°ï¼Œå¤„ç†å®¢æˆ·ç«¯è¿æ¥å’Œå·¥å…·è°ƒç”¨
- **å…³é”®ç‰¹æ€§**:
  - å®Œæ•´çš„MCPåè®®å®ç°
  - collect_feedbackå·¥å…·æ³¨å†Œ
  - Stdioå’ŒHTTPä¼ è¾“æ”¯æŒ
  - å¤šå®¢æˆ·ç«¯ä¼šè¯ç®¡ç†
- **æ ¸å¿ƒæ–¹æ³•**:
  - `start()`: å¯åŠ¨MCPæœåŠ¡å™¨
  - `collectFeedback()`: å¤„ç†åé¦ˆæ”¶é›†å·¥å…·è°ƒç”¨
  - `createMcpServerInstance()`: åˆ›å»ºMCPæœåŠ¡å™¨å®ä¾‹
  - `handleToolCall()`: å¤„ç†å·¥å…·è°ƒç”¨è¯·æ±‚
- **ä¸šåŠ¡é€»è¾‘**:
  - å·¥å…·æ³¨å†Œå’Œç®¡ç†
  - ä¼šè¯åˆ›å»ºå’Œéš”ç¦»
  - åé¦ˆæ•°æ®å¤„ç†
  - é”™è¯¯å¤„ç†å’Œæ¢å¤
- **ä»£ç ç»“æ„**: 646è¡Œä»£ç ï¼ŒåŒ…å«å®Œæ•´çš„MCPåè®®å®ç°

#### web-server.ts (WebæœåŠ¡å™¨)
- **è·¯å¾„**: `src/server/web-server.ts`
- **ä¸»è¦åŠŸèƒ½**: WebæœåŠ¡å’ŒSocket.IOå®æ—¶é€šä¿¡çš„æ ¸å¿ƒå®ç°
- **å…³é”®ç‰¹æ€§**:
  - Express WebæœåŠ¡å™¨
  - Socket.IOå®æ—¶é€šä¿¡
  - åœºæ™¯ç®¡ç†API
  - å›¾ç‰‡ä¸Šä¼ å¤„ç†
  - ä¼šè¯ç®¡ç†
  - æ€§èƒ½ç›‘æ§é›†æˆ
- **APIè·¯ç”±**:
  - `GET /api/scenes`: è·å–æ‰€æœ‰åœºæ™¯
  - `POST /api/scenes`: åˆ›å»ºæ–°åœºæ™¯
  - `PUT /api/scenes/:id`: æ›´æ–°åœºæ™¯
  - `DELETE /api/scenes/:id`: åˆ é™¤åœºæ™¯
  - `GET /api/scenes/:id/modes`: è·å–åœºæ™¯æ¨¡å¼
  - `POST /api/scenes/:sceneId/modes`: åˆ›å»ºåœºæ™¯æ¨¡å¼
- **Socket.IOäº‹ä»¶**:
  - `workSummaryUpdate`: å·¥ä½œæ±‡æŠ¥æ›´æ–°
  - `submitFeedback`: æäº¤åé¦ˆ
  - `feedbackSubmitted`: åé¦ˆæäº¤æˆåŠŸ
  - `connect/disconnect`: è¿æ¥çŠ¶æ€ç®¡ç†
- **ä¸šåŠ¡é€»è¾‘**:
  - HTTP APIå¤„ç†
  - å®æ—¶äº‹ä»¶å¤„ç†
  - ä¼šè¯æ˜ å°„ç®¡ç†
  - æ–‡ä»¶ä¸Šä¼ å¤„ç†
- **ä»£ç ç»“æ„**: 1990è¡Œä»£ç ï¼Œæ˜¯ç³»ç»Ÿæœ€å¤§çš„å•ä¸ªæ–‡ä»¶

#### server-coordinator.ts (æœåŠ¡å™¨åè°ƒå™¨)
- **è·¯å¾„**: `src/server/server-coordinator.ts`
- **ä¸»è¦åŠŸèƒ½**: å¤šæœåŠ¡å™¨å®ä¾‹çš„åè°ƒå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- **å…³é”®ç‰¹æ€§**:
  - æœåŠ¡å™¨å®ä¾‹ç®¡ç†
  - ç«¯å£åˆ†é…åè°ƒ
  - èµ„æºå…±äº«ç®¡ç†
  - ç”Ÿå‘½å‘¨æœŸæ§åˆ¶
- **æ ¸å¿ƒæ–¹æ³•**:
  - `startServers()`: å¯åŠ¨æ‰€æœ‰æœåŠ¡å™¨
  - `stopServers()`: åœæ­¢æ‰€æœ‰æœåŠ¡å™¨
  - `getServerStatus()`: è·å–æœåŠ¡å™¨çŠ¶æ€
  - `allocateResources()`: åˆ†é…èµ„æº
- **ä¸šåŠ¡é€»è¾‘**:
  - æœåŠ¡å™¨å¯åŠ¨é¡ºåºæ§åˆ¶
  - ç«¯å£å†²çªé¿å…
  - èµ„æºæ¸…ç†å’Œå›æ”¶
  - é”™è¯¯ä¼ æ’­å’Œå¤„ç†

### æ•°æ®åº“ç®¡ç†æ–‡ä»¶

#### prompt-database.ts (SQLiteæ•°æ®åº“ç®¡ç†)
- **è·¯å¾„**: `src/utils/prompt-database.ts`
- **ä¸»è¦åŠŸèƒ½**: SQLiteæ•°æ®åº“çš„å®Œæ•´ç®¡ç†ï¼ŒåŒ…æ‹¬åœºæ™¯ã€æ¨¡å¼ã€æç¤ºè¯å­˜å‚¨
- **å…³é”®ç‰¹æ€§**:
  - Better-SQLite3æ•°æ®åº“å¼•æ“
  - è·¨å¹³å°å­˜å‚¨è·¯å¾„ç®¡ç†
  - æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶å’Œè¿ç§»
  - å®Œæ•´çš„CRUDæ“ä½œ
  - äº‹åŠ¡å¤„ç†å’Œæ•°æ®å®Œæ•´æ€§
- **æ•°æ®è¡¨ç»“æ„**:
  - `scenes`: åœºæ™¯åŸºæœ¬ä¿¡æ¯
  - `scene_modes`: åœºæ™¯æ¨¡å¼é…ç½®
  - `scene_prompts`: åœºæ™¯æç¤ºè¯æ¨¡æ¿
  - `db_metadata`: æ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶
- **æ ¸å¿ƒæ–¹æ³•**:
  - `getAllScenes()`: è·å–æ‰€æœ‰åœºæ™¯
  - `createScene()`: åˆ›å»ºæ–°åœºæ™¯
  - `updateScene()`: æ›´æ–°åœºæ™¯
  - `deleteScene()`: åˆ é™¤åœºæ™¯
  - `getSceneModes()`: è·å–åœºæ™¯æ¨¡å¼
  - `createSceneMode()`: åˆ›å»ºåœºæ™¯æ¨¡å¼
  - `getScenePrompt()`: è·å–åœºæ™¯æç¤ºè¯
  - `saveScenePrompt()`: ä¿å­˜åœºæ™¯æç¤ºè¯
- **ä¸šåŠ¡é€»è¾‘**:
  - é»˜è®¤åœºæ™¯åˆå§‹åŒ–
  - æ•°æ®åº“è¿ç§»å¤„ç†
  - å¤–é”®çº¦æŸç®¡ç†
  - äº‹åŠ¡å¤„ç†
- **ä»£ç ç»“æ„**: 931è¡Œä»£ç ï¼ŒåŒ…å«å®Œæ•´çš„æ•°æ®åº“æ“ä½œé€»è¾‘

#### prompt-manager.ts (æç¤ºè¯ç®¡ç†å™¨)
- **è·¯å¾„**: `src/utils/prompt-manager.ts`
- **ä¸»è¦åŠŸèƒ½**: æç¤ºè¯çš„ä¸šåŠ¡é€»è¾‘ç®¡ç†å’Œæ¨¡æ¿å¤„ç†
- **å…³é”®ç‰¹æ€§**:
  - æç¤ºè¯æ¨¡æ¿æ¸²æŸ“
  - åœºæ™¯åŒ–æç¤ºè¯ç®¡ç†
  - å˜é‡æ›¿æ¢å’Œå¤„ç†
  - ç¼“å­˜æœºåˆ¶
- **æ ¸å¿ƒæ–¹æ³•**:
  - `getPromptForScene()`: è·å–åœºæ™¯æç¤ºè¯
  - `renderPromptTemplate()`: æ¸²æŸ“æç¤ºè¯æ¨¡æ¿
  - `validatePromptTemplate()`: éªŒè¯æç¤ºè¯æ¨¡æ¿
  - `cachePrompt()`: ç¼“å­˜æç¤ºè¯
- **ä¸šåŠ¡é€»è¾‘**:
  - æ¨¡æ¿å˜é‡å¤„ç†
  - åœºæ™¯ä¸Šä¸‹æ–‡é›†æˆ
  - æç¤ºè¯ç¼“å­˜ä¼˜åŒ–
  - é”™è¯¯å¤„ç†å’Œå›é€€

### å·¥å…·å’ŒåŸºç¡€è®¾æ–½æ–‡ä»¶

#### session-storage.ts (ä¼šè¯å­˜å‚¨ç®¡ç†)
- **è·¯å¾„**: `src/utils/session-storage.ts`
- **ä¸»è¦åŠŸèƒ½**: ä¼šè¯æ•°æ®çš„å­˜å‚¨å’Œç®¡ç†
- **å…³é”®ç‰¹æ€§**:
  - ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - å†…å­˜å­˜å‚¨ä¼˜åŒ–
  - ä¼šè¯è¶…æ—¶å¤„ç†
  - æ•°æ®åºåˆ—åŒ–
- **æ ¸å¿ƒæ–¹æ³•**:
  - `createSession()`: åˆ›å»ºä¼šè¯
  - `getSession()`: è·å–ä¼šè¯
  - `updateSession()`: æ›´æ–°ä¼šè¯
  - `deleteSession()`: åˆ é™¤ä¼šè¯
  - `cleanupExpiredSessions()`: æ¸…ç†è¿‡æœŸä¼šè¯

#### performance-monitor.ts (æ€§èƒ½ç›‘æ§å™¨)
- **è·¯å¾„**: `src/utils/performance-monitor.ts`
- **ä¸»è¦åŠŸèƒ½**: ç³»ç»Ÿæ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡æ”¶é›†
- **å…³é”®ç‰¹æ€§**:
  - å®æ—¶æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  - è¯·æ±‚å“åº”æ—¶é—´ç›‘æ§
  - èµ„æºä½¿ç”¨æƒ…å†µè·Ÿè¸ª
  - æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ
- **ç›‘æ§æŒ‡æ ‡**:
  - è¯·æ±‚å¤„ç†æ—¶é—´
  - æˆåŠŸ/å¤±è´¥ç‡
  - å†…å­˜ä½¿ç”¨æƒ…å†µ
  - CPUä½¿ç”¨ç‡
  - æ´»è·ƒä¼šè¯æ•°
- **æ ¸å¿ƒæ–¹æ³•**:
  - `recordRequest()`: è®°å½•è¯·æ±‚æŒ‡æ ‡
  - `recordSessionCreated()`: è®°å½•ä¼šè¯åˆ›å»º
  - `getMetrics()`: è·å–æ€§èƒ½æŒ‡æ ‡
  - `getFormattedReport()`: è·å–æ ¼å¼åŒ–æŠ¥å‘Š

#### image-processor.ts (å›¾ç‰‡å¤„ç†å™¨)
- **è·¯å¾„**: `src/utils/image-processor.ts`
- **ä¸»è¦åŠŸèƒ½**: å›¾ç‰‡ä¸Šä¼ ã€å¤„ç†å’Œå­˜å‚¨æœåŠ¡
- **å…³é”®ç‰¹æ€§**:
  - å¤šæ ¼å¼å›¾ç‰‡æ”¯æŒ
  - å›¾ç‰‡å‹ç¼©å’Œä¼˜åŒ–
  - æ–‡ä»¶å¤§å°é™åˆ¶
  - å®‰å…¨éªŒè¯
- **æ ¸å¿ƒæ–¹æ³•**:
  - `processImage()`: å¤„ç†å›¾ç‰‡
  - `validateImage()`: éªŒè¯å›¾ç‰‡
  - `compressImage()`: å‹ç¼©å›¾ç‰‡
  - `saveImage()`: ä¿å­˜å›¾ç‰‡

## ä¸šåŠ¡æµç¨‹åˆ†æ

### 1. MCPå·¥å…·è°ƒç”¨æµç¨‹

```mermaid
sequenceDiagram
    participant Client as MCP Client
    participant MCP as MCP Server
    participant WS as Web Server
    participant DB as SQLite Database
    participant FS as File System
    
    Client->>MCP: collect_feedback(work_summary)
    MCP->>MCP: ç”Ÿæˆä¼šè¯ID
    MCP->>DB: åˆ›å»ºä¼šè¯è®°å½•
    DB-->>MCP: ä¼šè¯åˆ›å»ºæˆåŠŸ
    
    MCP->>WS: åˆ›å»ºåé¦ˆä¼šè¯
    WS->>WS: å¯åŠ¨Socket.IOç›‘å¬
    WS->>FS: æ‰“å¼€åé¦ˆé¡µé¢
    FS-->>Client: æ˜¾ç¤ºåé¦ˆç•Œé¢
    
    Note over Client,FS: ç”¨æˆ·å¡«å†™åé¦ˆ
    
    WS->>MCP: åé¦ˆæ•°æ®æ”¶é›†å®Œæˆ
    MCP->>DB: ä¿å­˜åé¦ˆæ•°æ®
    DB-->>MCP: ä¿å­˜æˆåŠŸ
    MCP-->>Client: è¿”å›åé¦ˆç»“æœ
```

### 2. åœºæ™¯ç®¡ç†æµç¨‹

```mermaid
sequenceDiagram
    participant Frontend as å‰ç«¯ç•Œé¢
    participant WebAPI as Web API
    participant PM as Prompt Manager
    participant DB as Prompt Database
    
    Frontend->>WebAPI: POST /api/scenes
    WebAPI->>WebAPI: éªŒè¯åœºæ™¯æ•°æ®
    WebAPI->>PM: createScene(sceneData)
    PM->>DB: åˆ›å»ºåœºæ™¯è®°å½•
    DB->>DB: æ’å…¥åœºæ™¯æ•°æ®
    DB->>DB: åˆå§‹åŒ–é»˜è®¤æ¨¡å¼
    DB-->>PM: è¿”å›åˆ›å»ºç»“æœ
    PM-->>WebAPI: åœºæ™¯åˆ›å»ºæˆåŠŸ
    WebAPI-->>Frontend: è¿”å›æ–°åœºæ™¯æ•°æ®
    
    Frontend->>WebAPI: GET /api/scenes/{id}/modes
    WebAPI->>PM: getSceneModes(sceneId)
    PM->>DB: æŸ¥è¯¢åœºæ™¯æ¨¡å¼
    DB-->>PM: è¿”å›æ¨¡å¼åˆ—è¡¨
    PM-->>WebAPI: æ¨¡å¼æ•°æ®
    WebAPI-->>Frontend: è¿”å›æ¨¡å¼åˆ—è¡¨
```

### 3. å®æ—¶é€šä¿¡æµç¨‹

```mermaid
sequenceDiagram
    participant MCP as MCP Server
    participant WS as Web Server
    participant Socket as Socket.IO
    participant Frontend as å‰ç«¯ç•Œé¢
    
    MCP->>WS: æ¨é€å·¥ä½œæ±‡æŠ¥
    WS->>Socket: emit('workSummaryUpdate')
    Socket->>Frontend: æ¥æ”¶å·¥ä½œæ±‡æŠ¥äº‹ä»¶
    Frontend->>Frontend: æ›´æ–°ç•Œé¢æ˜¾ç¤º
    
    Frontend->>Socket: emit('submitFeedback')
    Socket->>WS: å¤„ç†åé¦ˆæäº¤
    WS->>WS: éªŒè¯å’Œå¤„ç†åé¦ˆæ•°æ®
    WS->>MCP: é€šçŸ¥åé¦ˆå®Œæˆ
    WS->>Socket: emit('feedbackSubmitted')
    Socket->>Frontend: åé¦ˆæäº¤æˆåŠŸ
```

## æ•°æ®æ¨¡å‹è¯¦è§£

### 1. åœºæ™¯æ•°æ®æ¨¡å‹

```typescript
// åœºæ™¯å®ä½“
interface Scene {
  id: string              // åœºæ™¯å”¯ä¸€æ ‡è¯†
  name: string           // åœºæ™¯åç§°
  description: string    // åœºæ™¯æè¿°
  icon?: string          // åœºæ™¯å›¾æ ‡
  is_default: boolean    // æ˜¯å¦ä¸ºé»˜è®¤åœºæ™¯
  sort_order: number     // æ’åºé¡ºåº
  created_at: number     // åˆ›å»ºæ—¶é—´æˆ³
  updated_at: number     // æ›´æ–°æ—¶é—´æˆ³
}

// åœºæ™¯æ¨¡å¼å®ä½“
interface SceneMode {
  id: string              // æ¨¡å¼å”¯ä¸€æ ‡è¯†
  scene_id: string       // æ‰€å±åœºæ™¯ID
  name: string           // æ¨¡å¼åç§°
  description: string    // æ¨¡å¼æè¿°
  shortcut?: string      // å¿«æ·é”®
  is_default: boolean    // æ˜¯å¦ä¸ºé»˜è®¤æ¨¡å¼
  sort_order: number     // æ’åºé¡ºåº
  default_feedback?: string // é»˜è®¤åé¦ˆå†…å®¹
  created_at: number     // åˆ›å»ºæ—¶é—´æˆ³
  updated_at: number     // æ›´æ–°æ—¶é—´æˆ³
}

// åœºæ™¯æç¤ºè¯å®ä½“
interface ScenePrompt {
  scene_id: string       // åœºæ™¯ID
  mode_id: string        // æ¨¡å¼ID
  prompt: string         // æç¤ºè¯å†…å®¹
  created_at: number     // åˆ›å»ºæ—¶é—´æˆ³
  updated_at: number     // æ›´æ–°æ—¶é—´æˆ³
}
```

### 2. ä¼šè¯æ•°æ®æ¨¡å‹

```typescript
// ä¼šè¯æ•°æ®
interface SessionData {
  workSummary: string    // å·¥ä½œæ±‡æŠ¥å†…å®¹
  feedback: FeedbackData[] // åé¦ˆæ•°æ®åˆ—è¡¨
  startTime: number      // ä¼šè¯å¼€å§‹æ—¶é—´
  timeout: number        // ä¼šè¯è¶…æ—¶æ—¶é—´
  mcpSessionId?: string  // MCPä¼šè¯ID
  status: 'active' | 'completed' | 'expired' // ä¼šè¯çŠ¶æ€
}

// åé¦ˆæ•°æ®
interface FeedbackData {
  text: string           // åé¦ˆæ–‡æœ¬
  images: ImageFile[]    // å›¾ç‰‡æ–‡ä»¶åˆ—è¡¨
  timestamp: number      // æäº¤æ—¶é—´æˆ³
  sessionId: string | null // ä¼šè¯ID
}
```

### 3. é…ç½®æ•°æ®æ¨¡å‹

```typescript
// æœåŠ¡å™¨é…ç½®
interface Config {
  port: number           // æœåŠ¡ç«¯å£
  corsOrigin: string     // CORSå…è®¸æº
  maxFileSize: number    // æœ€å¤§æ–‡ä»¶å¤§å°
  sessionTimeout: number // ä¼šè¯è¶…æ—¶æ—¶é—´
  dbPath?: string        // æ•°æ®åº“è·¯å¾„
  logLevel: string       // æ—¥å¿—çº§åˆ«
}

// æ€§èƒ½ç›‘æ§é…ç½®
interface PerformanceConfig {
  enableMonitoring: boolean // æ˜¯å¦å¯ç”¨ç›‘æ§
  metricsInterval: number   // æŒ‡æ ‡æ”¶é›†é—´éš”
  reportInterval: number    // æŠ¥å‘Šç”Ÿæˆé—´éš”
  maxMetricsHistory: number // æœ€å¤§å†å²è®°å½•æ•°
}
```

## æŠ€æœ¯ç‰¹ç‚¹

### 1. SQLiteæ•°æ®åº“é›†æˆ
- **Better-SQLite3**: é«˜æ€§èƒ½åŒæ­¥æ•°æ®åº“æ“ä½œ
- **è·¨å¹³å°å­˜å‚¨**: è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„å­˜å‚¨è·¯å¾„
- **æ•°æ®åº“è¿ç§»**: ç‰ˆæœ¬æ§åˆ¶å’Œè‡ªåŠ¨è¿ç§»
- **äº‹åŠ¡å¤„ç†**: ACIDäº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§
- **å¤–é”®çº¦æŸ**: æ•°æ®å®Œæ•´æ€§ä¿è¯

### 2. MCPåè®®å®ç°
- **æ ‡å‡†åè®®**: åŸºäº@modelcontextprotocol/sdk
- **å¤šä¼ è¾“æ¨¡å¼**: Stdioå’ŒHTTPä¼ è¾“æ”¯æŒ
- **å·¥å…·æ³¨å†Œ**: åŠ¨æ€å·¥å…·æ³¨å†Œå’Œç®¡ç†
- **ä¼šè¯éš”ç¦»**: å¤šå®¢æˆ·ç«¯ç‹¬ç«‹ä¼šè¯
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

### 3. å®æ—¶é€šä¿¡
- **Socket.IOæœåŠ¡å™¨**: é«˜æ€§èƒ½å®æ—¶é€šä¿¡
- **äº‹ä»¶é©±åŠ¨**: åŸºäºäº‹ä»¶çš„æ¶æ„è®¾è®¡
- **è¿æ¥ç®¡ç†**: è¿æ¥çŠ¶æ€è·Ÿè¸ªå’Œç®¡ç†
- **å¹¿æ’­æœºåˆ¶**: å¤šå®¢æˆ·ç«¯æ¶ˆæ¯å¹¿æ’­
- **è‡ªåŠ¨é‡è¿**: å®¢æˆ·ç«¯è‡ªåŠ¨é‡è¿æ”¯æŒ

### 4. æ€§èƒ½ç›‘æ§
- **å®æ—¶ç›‘æ§**: ç³»ç»Ÿæ€§èƒ½å®æ—¶è·Ÿè¸ª
- **æŒ‡æ ‡æ”¶é›†**: å…³é”®æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- **æŠ¥å‘Šç”Ÿæˆ**: è‡ªåŠ¨åŒ–æ€§èƒ½æŠ¥å‘Š
- **èµ„æºç›‘æ§**: CPUã€å†…å­˜ä½¿ç”¨ç›‘æ§
- **å‘Šè­¦æœºåˆ¶**: æ€§èƒ½å¼‚å¸¸å‘Šè­¦

### 5. æ¨¡å—åŒ–è®¾è®¡
- **æ¸…æ™°åˆ†å±‚**: æœåŠ¡å™¨ã€å·¥å…·ã€é…ç½®åˆ†å±‚
- **ä¾èµ–æ³¨å…¥**: æ¾è€¦åˆçš„ä¾èµ–ç®¡ç†
- **æ’ä»¶åŒ–**: æ”¯æŒåŠŸèƒ½æ¨¡å—æ’ä»¶åŒ–
- **å¯æ‰©å±•æ€§**: æ˜“äºæ‰©å±•å’Œç»´æŠ¤

## ğŸ§­ å¯¼èˆªé“¾æ¥

- **ğŸ“‹ [è¿”å›ä¸»ç›®å½•](../../README.md)** - è¿”å›æ–‡æ¡£å¯¼èˆªä¸­å¿ƒ
- **ğŸ”§ [è¿”å›æ¨¡å—ç›®å½•](./index.md)** - è¿”å›æœ¬æ¨¡å—å¯¼èˆª
- **ğŸ”§ [è¿”å›æ¨¡å—å±‚ç›®å½•](../index.md)** - è¿”å›æ¨¡å—å±‚å¯¼èˆª
- **ğŸ”„ [ä¸Šä¸€å±‚ï¼šäº¤äº’å±‚](../../äº¤äº’å±‚/index.md)** - è¿”å›äº¤äº’åˆ†æ
- **ğŸ”§ [åŒçº§ï¼šå‰ç«¯æ¨¡å—](../å‰ç«¯æ¨¡å—/è¯¦ç»†åˆ†æ.md)** - æŸ¥çœ‹å‰ç«¯æ¨¡å—åˆ†æ

---

*åç«¯æ¨¡å—è¯¦ç»†åˆ†ææœ€åæ›´æ–°: 2024å¹´1æœˆ* 